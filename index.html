<!DOCTYPE html>
<html style="height: 100%; width: 100%;">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  </head>
  <body style="box-sizing: border-box; width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden;">
    <div id="container" style="box-sizing: border-box; width: 100%; height: 100%; position: relative; margin: 0; padding: 0; background-color: black;">
      <canvas id="mapCanvas" tabindex="0" style="width: 100%; height: 100%; z-index: 1; touch-action: none;"></canvas>
      <div style="z-index: 2; position: absolute; top: 0; left: 0; padding: 2px; box-sizing: border-box;">
        <button id="loadPCD">load</button>
        <button id="savePCD">save</button>
        <button id="exportPCD">export</button>
        <input type="text" id="command" style="opacity: 0.8;" />
      </div>
      <div id="log" style="font-size: 0.6em; max-height: 20em; position: absolute; bottom: 1em; left: 1em; z-index: 2; color: white; pointer-events: none; overflow: hidden;"></div>
    </div>
  </body>
  <script src="wasm_exec.js"></script>
  <script>
    const query = new URLSearchParams(window.location.search)
    let loadPath = '/data/map.pcd'
    if (query.has('source')) {
      loadPath = query.get('source')
    }

    document.onPCDEditorLoaded = e => {
      const logger = msg => {
        const log = document.getElementById("log");
        log.innerHTML = msg.toString().replace(/\n/g, "<br/>") + "<br/>" + log.innerHTML;
      };
      const pcdeditor = e.attach(document.getElementById("mapCanvas"), {logger: logger});
      document.getElementById("loadPCD").onclick =
        () => pcdeditor.loadPCD(loadPath).catch(logger);
      document.getElementById("savePCD").onclick =
        () => pcdeditor.savePCD('/upload/map.pcd').catch(logger);
      document.getElementById("exportPCD").onclick =
        () => pcdeditor.exportPCD("exported.pcd").catch(logger);
      document.getElementById("command").onkeydown =
        e => {
          if (e.keyCode == 13) {
            pcdeditor.command(e.target.value).then(msg => {
              if (msg != "") {
                logger(msg)
              }
            }).catch(logger);
            e.target.value = "";
          }
          if (e.keyCode == 27) {
            document.getElementById("mapCanvas").focus();
          }
        };
    }
    const go = new Go();
    WebAssembly.instantiateStreaming(fetch("pcdeditor.wasm"), go.importObject).then((result) => {
      go.run(result.instance);
    });
  </script>
</html>
